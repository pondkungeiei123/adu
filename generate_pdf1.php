<?php
// เปิดการแสดงข้อผิดพลาดเพื่อดีบัก
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// กำหนดไดเรกทอรีชั่วคราว
if (!defined('K_PATH_CACHE')) {
    define('K_PATH_CACHE', __DIR__ . '/tcpdf/cache/');
}

require_once 'config.php';
require_once 'tcpdf/tcpdf.php'; // ปรับ path ตามที่คุณวางไฟล์ TCPDF

// ฟังก์ชันแปลงวันที่เป็นรูปแบบไทย
function formatThaiDate($date)
{
    if (empty($date)) return "";

    $thai_months = [
        '01' => 'มกราคม',
        '02' => 'กุมภาพันธ์',
        '03' => 'มีนาคม',
        '04' => 'เมษายน',
        '05' => 'พฤษภาคม',
        '06' => 'มิถุนายน',
        '07' => 'กรกฎาคม',
        '08' => 'สิงหาคม',
        '09' => 'กันยายน',
        '10' => 'ตุลาคม',
        '11' => 'พฤศจิกายน',
        '12' => 'ธันวาคม'
    ];

    $date_parts = explode('-', $date);
    if (count($date_parts) == 3) {
        $year = (int)$date_parts[0] + 543; // แปลงเป็นปี พ.ศ.
        $month = $thai_months[$date_parts[1]];
        $day = (int)$date_parts[2]; // ตัด 0 นำหน้าออก

        return "$day $month $year";
    }

    return $date; // ถ้าแปลงไม่ได้ ส่งค่าเดิมกลับไป
}

// สร้างคลาส PDF สืบทอดจาก TCPDF
class PDF extends TCPDF
{
    public function Header()
    {
        $this->Ln(10); // ระยะห่างจากขอบบน

        // หัวเรื่อง
        $this->SetFont('THSarabunNew', 'B', 18);
        $this->Cell(0, 8, ' ใบรายงานผลตรวจสมรรถภาพการได้ยินติดตาม', 0, 1, 'C');
        $this->Cell(0, 8, ' (Monitoring Audiogram) ปี 2568', 0, 1, 'C');

        // ข้อมูลโรงพยาบาล แสดงที่มุมขวาบน
        $this->SetFont('THSarabunNew', '', 16);
        $hospitalInfo = "โรงพยาบาลร้อยเอ็ด\n111 ถ.รณชัยชาญยุทธ\nอ.เมือง จ.ร้อยเอ็ด 45000\nโทร 043-518200";

        // ตั้งตำแหน่ง X,Y มุมขวาบน (ปรับตามขนาดกระดาษและ margin)
        $this->SetXY(-80, 10); // 80 คือความกว้างกล่องข้อมูล
        $this->MultiCell(70, 6, $hospitalInfo, 0, 'R'); // 70 คือความกว้างของข้อความ

        $this->Ln(5); // เว้นบรรทัดก่อนเริ่มข้อมูลอื่น
    }
    // เอาไว้เเสดงตัวเลข จะไปเเสดงที่ใต้กระดาษ ตรงFooterอ่ะ

    // public function Footer()
    // {
    //     $this->SetY(-15);
    //     $this->SetFont('THSarabunNew', 'I', 8);
    //     $this->Cell(0, 10, 'Page ' . $this->getAliasNumPage(), 0, 0, 'C');
    // }

    // ฟังก์ชันคำนวณสรุปผลการได้ยิน
    public function CalculateHearingSummary($row)
    {

        // กำหนดความถี่พร้อมค่าระดับการได้ยิน
        $rightLowFreq = [
            '500 Hz' => floatval($row['right_500']),
            '1000 Hz' => floatval($row['right_1000']),
            '2000 Hz' => floatval($row['right_2000'])
        ];
        $leftLowFreq = [
            '500 Hz' => floatval($row['left_500']),
            '1000 Hz' => floatval($row['left_1000']),
            '2000 Hz' => floatval($row['left_2000'])
        ];
        $rightHighFreq = [
            '3000 Hz' => floatval($row['right_3000']),
            '4000 Hz' => floatval($row['right_4000']),
            '6000 Hz' => floatval($row['right_6000']),
            '8000 Hz' => floatval($row['right_8000'])
        ];
        $leftHighFreq = [
            '3000 Hz' => floatval($row['left_3000']),
            '4000 Hz' => floatval($row['left_4000']),
            '6000 Hz' => floatval($row['left_6000']),
            '8000 Hz' => floatval($row['left_8000'])
        ];

        // ตรวจสอบความถี่ที่เกิน 25 dB
        $rightExceedFreqs = [];
        foreach ($rightLowFreq + $rightHighFreq as $freq => $value) {
            if ($value > 25) {
                $rightExceedFreqs[] = $freq;
            }
        }

        $leftExceedFreqs = [];
        foreach ($leftLowFreq + $leftHighFreq as $freq => $value) {
            if ($value > 25) {
                $leftExceedFreqs[] = $freq;
            }
        }

        // สร้างข้อความสำหรับหูขวาและหูซ้าย
        $rightEarDesc = !empty($rightExceedFreqs)
            ? "หูขวา: ระดับการได้ยินลดลงที่ความถี่ " . implode(' และ ', $rightExceedFreqs)
            : "หูขวา: ระดับการได้ยินปกติ";

        $leftEarDesc = !empty($leftExceedFreqs)
            ? "หูซ้าย: ระดับการได้ยินลดลงที่ความถี่ " . implode(' และ ', $leftExceedFreqs)
            : "หูซ้าย: ระดับการได้ยินปกติ";


        $maxRightLow = max($rightLowFreq);
        $maxRightHigh = max($rightHighFreq);
        $maxLeftLow = max($leftLowFreq);
        $maxLeftHigh = max($leftHighFreq);

        $summary = '';
        $recommendation = '';

        $rightExceed = [];
        $leftExceed = [];



        // สร้างสรุปผลรวม



        // สร้างข้อความสรุปผล
        $detailSummary = implode("\n", array_merge($rightExceed, $leftExceed));



        // เงื่อนไขตามสูตร
        if ($maxRightLow <= 25 && $maxRightHigh <= 25 && $maxLeftLow <= 25 && $maxLeftHigh <= 25) {
            $summary = "พนักงานมีระดับการได้ยินปกติทั้งสองข้าง";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxRightHigh > 25 && $maxLeftLow > 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำและความถี่สูงของหูทั้งสองข้าง";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxRightHigh > 25 && $maxLeftLow <= 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำและความถี่สูงของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่สูงของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxRightHigh > 25 && $maxLeftLow > 25 && $maxLeftHigh <= 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำและความถี่สูงของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่ต่ำของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxRightHigh > 25 && $maxLeftLow <= 25 && $maxLeftHigh <= 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำและความถี่สูงของหูข้างขวา และมีระดับการได้ยินปกติของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxRightHigh <= 25 && $maxLeftLow > 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่ต่ำและความถี่สูงของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow <= 25 && $maxRightHigh > 25 && $maxLeftLow > 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่สูงของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่ต่ำและความถี่สูงของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow <= 25 && $maxRightHigh <= 25 && $maxLeftLow > 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีระดับการได้ยินปกติของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่ต่ำและความถี่สูงของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxRightHigh <= 25 && $maxLeftLow <= 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่สูงของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxRightHigh <= 25 && $maxLeftLow <= 25 && $maxLeftHigh <= 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำของหูข้างขวา และมีระดับการได้ยินปกติของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow <= 25 && $maxRightHigh > 25 && $maxLeftLow <= 25 && $maxLeftHigh <= 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่สูงของหูข้างขวา และมีระดับการได้ยินปกติของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow <= 25 && $maxRightHigh <= 25 && $maxLeftLow > 25 && $maxLeftHigh <= 25) {
            $summary = "พนักงานมีระดับการได้ยินปกติของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่ต่ำของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow <= 25 && $maxRightHigh <= 25 && $maxLeftLow <= 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีระดับการได้ยินปกติของหูข้างขวา และมีการสูญเสียการได้ยิน ความถี่สูงของหูข้างซ้าย";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow > 25 && $maxLeftLow > 25 && $maxRightHigh <= 25 && $maxLeftHigh <= 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่ต่ำของหูทั้งสองข้าง";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else if ($maxRightLow <= 25 && $maxLeftLow <= 25 && $maxRightHigh > 25 && $maxLeftHigh > 25) {
            $summary = "พนักงานมีการสูญเสียการได้ยิน ความถี่สูงของหูทั้งสองข้าง";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        } else {
            $summary = "พนักงานมีการสูญเสียการได้ยินในรูปแบบที่ไม่สามารถระบุได้อย่างชัดเจน";
            $recommendation = `
                <div class="recommendation">
                    <p><strong>คำแนะนำ:</strong></p>
                    <ol>
                        <li>ควรหลีกเลี่ยงเสียงดัง สวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดัง และเข้ารับการตรวจ ติดตามการได้ยินต่อเนื่องทุกปี</li>
                        <li>ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ</li>
                        <li>ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ</li>
                    </ol>
                    <p><strong>หมายเหตุ:</strong></p>
                    <p>ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดัง ทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด</p>
                </div>
            `;
        }
        // คำแนะนำ
        if ($summary !== "พนักงานมีระดับการได้ยินปกติทั้งสองข้าง") {
            $recommendation = "▪ ควรหลีกเลี่ยงเสียงดังสวมอุปกรณ์ปกป้องการได้ยินทุกครั้งที่สัมผัสเสียงดังและเข้ารับการตรวจติดตามการได้ยินต่อ\nเนื่องทุกปี\n" .
                "▪ ควรปรึกษาแพทย์ หู คอ จมูก เพื่อตรวจหาสาเหตุ\n" .
                "▪ ควรนำผลที่ได้ไปเทียบกับ base line เดิมก่อนเข้าทำงาน หากมีการได้ยินลดลงมากกว่า 15 dB ที่ความถี่ใดความถี่หนึ่ง ให้ปฏิบัติตามมาตรการอนุรักษ์การได้ยินและควรมีการตรวจซ้ำ\n" .
                "หมายเหตุ:\n ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดังทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด";
        } else {
            $recommendation = "     ก่อนรับการตรวจสมรรถภาพการได้ยิน ควรเตรียมตัวให้ผู้เข้ารับการตรวจ หลีกเลี่ยงการสัมผัสเสียงดังทุกชนิดอย่างน้อย 12 ชั่วโมง เพื่อป้องกันภาวะหูตึงชั่วคราว (Temporary threshold shift) ซึ่งอาจทำให้ผลการตรวจผิดพลาด";
        }

        return [
            'summary' => $summary,
            'rightEarDetail' => $rightEarDesc,
            'leftEarDetail' => $leftEarDesc,
            'detailSummary' => $detailSummary,
            'recommendation' => $recommendation
        ];
    }

    // ฟังก์ชันสร้างรายงาน
    public function AudiogramReport($audio_records)
    {
        $this->SetFont('THSarabunNew', 'B', 16);
        $this->Ln(5);

        foreach ($audio_records as $index => $row) {
            // หัวข้อของแต่ละคน
            $this->SetFont('THSarabunNew', 'B', 18);
            $this->Ln(15);

            // ข้อมูลส่วนตัว
            $this->SetFont('THSarabunNew', '', 16);
            $this->Cell(60, 8, 'สถานประกอบการ: ' . $row['establishment_name'], 0);
            $this->Cell(60, 8, '                        แผนก: ' . $row['department'], 0);
            $this->Ln();
            $this->Cell(60, 8, "ชื่อ " . $row['firstName'] . " " . $row['lastName'], 0);
            $this->Ln();
            $this->Cell(60, 8, 'เพศ: ' . $row['gender'], 0);
            $this->Cell(60, 8, 'อายุ: ' . $row['age'] . ' ปี', 0);
            $this->Cell(60, 8, 'HN: ' . $row['hn'], 0);
            $this->Ln();
            $this->Cell(60, 8, 'น้ำหนัก: ' . $row['weight'] . ' กก.', 0);
            $this->Cell(60, 8, 'ส่วนสูง: ' . $row['height'] . ' ซม.', 0);
            $this->Cell(60, 8, 'BMI: ' . $row['bmi'], 0);
            $this->Ln();
            $this->Cell(60, 8, 'หมวดหมู่ BMI: ' . $row['bmi_category'], 0);
            $this->Cell(60, 8, 'การเต้นของหัวใจ: ' . $row['heartRate'] . ' ครั้ง/นาที', 0);
            $this->Ln();
            $this->Cell(60, 8, 'ความดันโลหิต: ' . $row['sbp'] . '/' . $row['dbp'] . ' mmHg', 0);
            $this->Cell(60, 8, 'หมวดหมู่ความดัน: ' . $row['bloodPressure_category'], 0);
            $this->Ln(10);
            // แก้ไขการแสดงวันที่ให้เป็นรูปแบบไทย
            $this->Cell(60, 8, 'วันที่ตรวจ: ' . formatThaiDate($row['exam_date']), 0);
            $this->Ln(10);
            // ตาราง Audiogram
            $this->SetFont('THSarabunNew', 'B', 16);
            $this->Cell(25, 8, 'ความถี่ (Hz)', 1, 0, 'C');
            $this->Cell(20, 8, '500', 1, 0, 'C');
            $this->Cell(20, 8, '1000', 1, 0, 'C');
            $this->Cell(20, 8, '2000', 1, 0, 'C');
            $this->Cell(20, 8, '3000', 1, 0, 'C');
            $this->Cell(20, 8, '4000', 1, 0, 'C');
            $this->Cell(20, 8, '6000', 1, 0, 'C');
            $this->Cell(20, 8, '8000', 1, 0, 'C');
            $this->Ln();

            $this->SetFont('THSarabunNew', '', 16);
            $this->Cell(25, 8, 'หูขวา (dB)', 1, 0, 'C');
            $this->Cell(20, 8, $row['right_500'], 1, 0, 'C');
            $this->Cell(20, 8, $row['right_1000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['right_2000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['right_3000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['right_4000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['right_6000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['right_8000'], 1, 0, 'C');
            $this->Ln();

            $this->Cell(25, 8, 'หูซ้าย (dB)', 1, 0, 'C');
            $this->Cell(20, 8, $row['left_500'], 1, 0, 'C');
            $this->Cell(20, 8, $row['left_1000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['left_2000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['left_3000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['left_4000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['left_6000'], 1, 0, 'C');
            $this->Cell(20, 8, $row['left_8000'], 1, 0, 'C');
            $this->Ln(10);



            // สรุปผลตรวจและคำแนะนำ
            $hearingResult = $this->CalculateHearingSummary($row);

            // แสดงข้อความสำหรับหูขวา
            $this->SetFont('THSarabunNew', 'B', 16);
            // ตรวจสอบตำแหน่ง Y ก่อนแสดงข้อความหูขวา
            if ($this->GetY() > 250) { // หากตำแหน่ง Y เกิน 250 หน่วย ให้ขึ้นหน้าใหม่
                $this->AddPage();
            }
            $this->MultiCell(0, 8, $hearingResult['rightEarDetail'], 0, 'L');

            // แสดงข้อความสำหรับหูซ้าย
            $this->SetFont('THSarabunNew', 'B', 16);
            // ตรวจสอบตำแหน่ง Y ก่อนแสดงข้อความหูซ้าย
            if ($this->GetY() > 250) { // หากตำแหน่ง Y เกิน 250 หน่วย ให้ขึ้นหน้าใหม่
                $this->AddPage();
            }
            $this->MultiCell(0, 8, $hearingResult['leftEarDetail'], 0, 'L');
            $this->SetFont('THSarabunNew', '', 16);

            // สรุปผลตรวจ
            // ตั้งค่าฟอนต์ตัวหนาสำหรับ "สรุปผลตรวจ:"
            $this->SetFont('THSarabunNew', 'B', 16);
            $this->Write(8, 'สรุปผลตรวจ: ');

            // ตั้งค่าฟอนต์ปกติสำหรับข้อความถัดมา
            $this->SetFont('THSarabunNew', '', 16);
            $this->Write(8, $hearingResult['summary']);
            $this->Ln(10); // เว้นบรรทัดหลังข้อความ

            // คำแนะนำ
            $this->SetFont('THSarabunNew', 'B', 16);
            $this->Cell(0, 8, 'คำแนะนำ:', 0, 1);
            $this->SetFont('THSarabunNew', '', 16);
            $this->MultiCell(0, 8, $hearingResult['recommendation'], 0, 'L');


            // ตำแหน่งลายเซ็นแพทย์ - กำหนดตำแหน่งแบบตายตัว
            $this->SetFont('THSarabunNew', '', 16);
            $this->SetY(-70); // กำหนดตำแหน่ง Y จากด้านล่างขึ้นมา 70 หน่วย (ปรับตามความเหมาะสม)
            $this->Ln(5);
            $this->Cell(0, 6, '                                                                                                                 แพทย์ผู้แปลผล', 0, 1,);
            $this->Ln(5);
            $this->Cell(0, 8, '                                                                                                      ...................................................', 0, 1,);
            $this->Ln(3);
            $this->Cell(0, 8, '                                                                                                       (พญ.นภัฐมณ มโนรัตน์ ว.42781 )', 0, 1, '');
            $this->Cell(0, 6, '                                                                                                             แพทย์อาชีวเวชศาสตร์', 0, 1,);
            $this->Ln(8);
            // ตรวจสอบการขึ้นหน้าใหม่
            if ($this->GetY() > 250) {
            }
        }
    }
}

// ป้องกัน output ก่อนสร้าง PDF
ob_start();

// ดึงข้อมูลจากฐานข้อมูล
$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if ($id > 0) {
    $sql = "SELECT ar.*, e.name AS establishment_name 
        FROM audio_records ar
        LEFT JOIN establishment e ON ar.establishment_id = e.id
        WHERE ar.id = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $result = $stmt->get_result();
} else {
    $sql = "SELECT * FROM audio_records ORDER BY id DESC";
    $result = $conn->query($sql);
}

$audio_records = [];
while ($row = $result->fetch_assoc()) {
    $audio_records[] = $row;
}

if (empty($audio_records)) {
    die("ไม่มีข้อมูลสำหรับสร้าง PDF");
}

// สร้าง PDF
$pdf = new PDF();
$pdf->SetMargins(15, 20, 15);
$pdf->AddPage();
$pdf->AddFont('THSarabunNew', '', 'THSarabunNew.php');
$pdf->AddFont('THSarabunNew', 'B', 'thsarabunnewb.php');
$pdf->AudiogramReport($audio_records);

// ล้าง buffer และส่งออก PDF
if (ob_get_length()) {
    ob_clean();
}
ob_end_clean();
$pdf->Output('audiogram_report.pdf', 'D');
$conn->close();
exit();
